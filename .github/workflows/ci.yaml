name: CI

on:
  pull_request:
    branches:    
      - main
    types: 
      - opened
      - reopened
      - edited
      - synchronize

jobs:
  tests:
    name: Run tests
    uses: ./.github/workflows/tests.yaml

  summarize-pull-request:
    name: Summarize pull request
    uses: ./.github/workflows/summarize-pull-request.yaml
  
  check-pull-request:
    name: Check pull request
    needs: [summarize-pull-request]
    uses: ./.github/workflows/check-pull-request.yaml
    with:
      summary: ${{ needs.summarize-pull-request.outputs.summary }}

  build:
    name: Build
    needs: [tests, check-pull-request]
    runs-on: ubuntu-latest
    if: ${{ needs.tests.result == 'success'  && needs.check-pull-request.outputs.version-bump != 'none'}}
    steps:
      - name: Build
        uses: ./.github/workflows/build.yaml

  update-pull-request-description:
    name: Update pull request description
    needs: [summarize-pull-request]
    runs-on: ubuntu-latest
    steps:
      - name: Update pull request description
        uses: riskledger/update-pr-description@v2
        with:
          body: ${{ needs.summarize-pull-request.outputs.summary }}
          token: ${{ secrets.GITHUB_TOKEN }}